<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Research Demo</title>
  <link rel="stylesheet" href="../dist/css/scrollspy.dark.css"/>
  <style>
    .main-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background-image: 
        linear-gradient(rgba(4, 55, 83, 0.7), rgba(4, 83, 40, 0.7)), 
        url('../img/Home/17.webp');
      background-size: cover;
      background-position: top;
      animation: moveBg 280s infinite alternate;
      color: white;
      min-height: 60vh;
      box-sizing: border-box;
    }


  @keyframes moveBg {
    0%   { background-position: top; }
    50%  { background-position: bottom; }
    100% { background-position: top; }
  }

  /* ===== 主圖 + 輔助圖容器 ===== */
  .img-container {
    display: flex;
    flex-direction: column; /* 主圖在上，輔助圖在下 */
    align-items: center;
    gap: 20px;
    margin-top: 80px;
    width: 100%;
  }

  /* 主圖 */
  .research-image {
    width: 100%;
    max-width: 1080px;
    height: auto;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .research-image:hover {
    transform: scale(1.05);
  }

  /* ===== 輔助圖容器（橫向滾動） ===== */
  .img-more-container {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    gap: 10px;
    scroll-snap-type: x mandatory;
    width: 100%;
    margin-top: 20px;
    justify-content: flex-start;
  }

  .img-more-container::-webkit-scrollbar {
    height: 8px;
  }

  .img-more-container::-webkit-scrollbar-thumb {
    background: linear-gradient(120deg, #f36f24, #12163f);
    border-radius: 4px;
  }

  /* 輔助圖 */
  .img-more-container img {
    height: 460px;
    width: auto;
    cursor: pointer;
    transition: transform 0.3s ease, filter 0.3s ease;
  }

  /* 當滑鼠在容器上：全部圖片變灰 */
  .img-more-container:hover img {
    filter: grayscale(100%);
    transform: scale(1); /* 確保非 hover 圖片保持原大小 */
  }

  /* 滑鼠在單張圖片上：恢復原色並放大 */
  .img-more-container img:hover {
    filter: none;
    transform: scale(1.1);
    z-index: 2; /* 放大時在最上層，避免被遮住 */
  }

  .centered-img { display: block; margin: 0 auto; }
  .cursor:hover { cursor: pointer; }

  /* ===== 遮罩 (Modal) ===== */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    inset: 0;
    overflow: auto;
    background-color: rgba(37, 37, 37, 0.6);
  }

  /* 遮罩內圖片：置中，限制不超過視窗大小 */
  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: block;

    max-width: 90vw;
    max-height: 90vh;

    width: auto;
    height: auto;
    object-fit: contain;
    image-rendering: -webkit-optimize-contrast;
  }

  /* 關閉按鈕 */
  .close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    transition: 0.2s;
    cursor: pointer;
    z-index: 1002;
  }

  .close:hover, .close:focus {
    color: #bbb;
    text-decoration: none;
  }

  /* 左右切換箭頭 */
  .img_arrow {
    cursor: pointer;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    padding: 16px;
    color: #fff;
    font-weight: bold;
    font-size: 18px;
    transition: 0.2s ease;
    user-select: none;
    z-index: 1001;
  }

  .prev { left: 0; }
  .next { right: 0; }
  .img_arrow:hover { background-color: rgba(0, 0, 0, 0.8); }

  /* 打開遮罩時禁用背景滾動 */
  body.modal-open { overflow: hidden; }


/* 無連結時，強制 hover 不變色、不顯示手型游標 */
  .researcher-link[data-has-link="false"]:hover {
    color: inherit !important;
    cursor: default !important;
    text-decoration: none !important;
  }

  /* 作者：無連結時，強制 hover 不變色、游標非 pointer */
  .author-link[data-has-link="false"],
  .cont-researcher-name[data-has-link="false"] {
    cursor: default !important;
  }
  .author-link[data-has-link="false"]:hover,
  .cont-researcher-name[data-has-link="false"]:hover {
    color: inherit !important;
    text-decoration: none !important;
  }
</style>
</head>
<body>
  <header>
    <div class="logo-container"></div>
    <nav class="scrollspy-nav">
      <a class="scrollspy-link" href="../index.html">Home</a>
      <a class="scrollspy-link" href="../research.html">Research</a>
      <a class="scrollspy-link" href="../publications.html">Publications</a>
      <a class="scrollspy-link" href="../people.html">People</a>     
      <a class="scrollspy-link" href="../news.html">News</a>
      <a class="scrollspy-link" href="../activity.html">Activity</a>
      <a class="scrollspy-link" href="resource.html">Resource</a>
    </nav>   
  </header>

  <section class="scrollspy-section main-content" id="">
    <div class="main">
      <div class="about">
        <div class="intro_text_research" id="researchTitle"></div>
        <div class="name" id="researchName" style="color:white"></div>
        <div class="cont" id="researchContent" style="color:white"></div>
        <div id="researchers-info" style="margin-bottom: 20px;"></div> <!-- 显示researchers信息 -->
        <div class="keywords-container"></div>
        <div class="download-container"></div>
      </div>
    </div>
  </section>

  <div class="gray">
    <div class="section_1">
      <div class="title">Latest News
        <div class="line"></div>
      </div>
      <div class="cont margin_left">
        ● What is Lorem Ipsum?<br>
        ● Lorem Ipsum is simply dummy text of the printing and typesetting industry.  <a href="https://www.lipsum.com" 
        style="text-decoration: none; color:#3f44b6;" rel="alternate bookmark" target="_blank">
        Lorem Ipsum has been the industry's standard dummy text ever since the 1500s</a> 
        when an unknown printer took a galley of type and scrambled it to make a type specimen book.<br>
        ● It has survived not only five centuries<a href="https://www.lipsum.com" 
        style="text-decoration: none; color:#3f44b6;" rel="alternate bookmark" target="_blank">
        but also the leap into electronic typesetting, remaining essentially unchanged.</a> <br>
      </div>
    </div>
  </div>

  <!-- Abstract（保留原標題樣式與主圖） -->
  <section class="scrollspy-section" id="Abstract">
    <div class="section_2">
      <div class="title">Abstract
        <div class="line"></div>
      </div>
      <div class="abstract-container">
        <div id="researchAbstract"></div>
        <div class="img-container">
          <img src="" id="mainImage" class="research-image centered-img" alt="Main Image"/>
        </div>
      </div>
    </div>
  </section>

  <!-- 新增：Introduction（樣式與 Abstract 相同；僅當有 intro 時顯示） -->
  <section class="scrollspy-section" id="Introduction">
    <div class="section_2">
      <div class="title">Introduction
        <div class="line"></div>
      </div>
      <div class="abstract-container">
        <div id="researchIntro"></div>
      </div>
    </div>
  </section>

  <!-- 輔圖滾動欄：緊接在 Introduction 後面（若 Introduction 隱藏，這塊仍會出現在其位置） -->
  <section class="scrollspy-section" id="MoreImages">
    <div class="section_2">
      <div id="imgMoreContainer"></div>
    </div>
  </section>

  <!-- 懸浮框 -->
  <div id="myModal" class="modal">
    <span class="close">&times;</span>
    <span class="prev img_arrow">&#10094;</span>
    <img class="modal-content" id="modalImage">
    <span class="next img_arrow">&#10095;</span>
  </div>

  <section class="scrollspy-section" id="Publications">
    <div class="section_2">
      <div class="title">Publications
        <div class="line"></div>
      </div>
      <div class="mn-acc-app">
        <div class="mn-accordion" id="accordion-2">
          <!-- JSON data will be inserted here by JavaScript -->
        </div>
      </div>
    </div>
  </section>

  <section class="scrollspy-section" id="Videos">
    <div class="section_2">
      <div class="title">Videos
        <div class="line"></div>
      </div>
      <div id="info-content">
        <!-- JSON data will be inserted here by JavaScript -->
      </div>
    </div>
  </section>

  <section class="scrollspy-section" id="Contact" style="margin-top: 20px;">
    <div class="gray">
      <div class="section_2">
        <div class="title">Contact
            <div class="line"></div>
        </div>
        <div class="sec_sub_title" id="contact-details">
          <!-- Contact details will be loaded here by JavaScript -->
        </div>
       </div>
    </div>
  </section>
  
  <div class="footer">
    <p>
      <a href="#">About</a> | 
      <a href="#">Contact Us</a> | 
      <a href="#">Copyright</a> | 
      <a href="#">Terms of Use</a> | 
      <a href="#">Privacy Policy</a>
    </p>
    <p>© 2025 All rights reserved</p>
  </div>

  <script src="../../dist/js/mn-accordion.js"></script>
  <script src="../../dist/js/scrollspy.min.js"></script>
  <script>
document.addEventListener("DOMContentLoaded", function() {
  const modal = document.getElementById("myModal");
  const modalImg = document.getElementById("modalImage");
  const closeBtn = document.getElementsByClassName("close")[0];
  let zoomedIn = false;
  let currentImgIndex = 0;
  let imgMoreList = [];

  // 1) 載入研究主內容
  fetch('/json/research/research.json')
    .then(response => response.json())
    .then(data => {
      const research = (Array.isArray(data) ? data : []).find(item => Array.isArray(item.label) && item.label.includes("researchDemo"));
      if (!research) return;

// 主圖
const mainImage = document.getElementById("mainImage");
imgMoreList = [
  research.imgSrc,
  ...(Array.isArray(research.imgMore) ? research.imgMore.filter(Boolean) : [])
];
mainImage.src = research.imgSrc;
mainImage.classList.add("centered-img");

// 開啟遮罩
function openModalWithIndex(idx) {
  currentImgIndex = idx;
  modalImg.src = imgMoreList[currentImgIndex];
  modal.style.display = "block";
  modalImg.classList.remove('zoom-in', 'zoom-out');
  document.body.classList.add('modal-open');
}

// 關閉遮罩（恢復滾動）
function closeModal() {
  modal.style.display = "none";
  document.body.classList.remove('modal-open');
  modalImg.classList.remove('zoom-in', 'zoom-out');
}

mainImage.onclick = () => openModalWithIndex(0);

// 綁定關閉事件
const closeBtn = document.querySelector('.close');
if (closeBtn) closeBtn.onclick = closeModal;

// 點擊遮罩背景也關閉
modal.addEventListener('click', (e) => {
  if (e.target === modal) closeModal();
});

// Esc 鍵也能關閉
document.addEventListener('keydown', (e) => {
  if (modal.style.display === 'block' && (e.key === 'Escape' || e.key === 'Esc')) {
    closeModal();
  }
});

// ===== Introduction 區塊：只有有 intro 才顯示 =====
const introSection = document.getElementById('Introduction');
const introHolder  = document.getElementById('researchIntro');
if (research.intro && String(research.intro).trim()) {
  const formattedIntro = String(research.intro).replace(/\n/g, '<br>');
  introHolder.innerHTML = formattedIntro;
  introSection.style.display = ''; // 顯示
} else {
  introSection.style.display = 'none'; // 整塊隱藏（含標題）
}

// ===== 輔圖（滾動欄放在 Introduction 後面）=====
const imgMoreContainer = document.getElementById('imgMoreContainer');

function updateArrowState() {
  const prevArrow = document.querySelector('.prev');
  const nextArrow = document.querySelector('.next');
  if (!prevArrow || !nextArrow) return;
  if (imgMoreList.length <= 1) {
    prevArrow.style.display = 'none';
    nextArrow.style.display = 'none';
  } else {
    prevArrow.style.display = 'block';
    nextArrow.style.display = 'block';
  }
}

// 清空容器後再渲染
imgMoreContainer.innerHTML = '';

if (imgMoreList.length === 2) {
  // 只有 1 張輔圖 → 直接置中顯示
  const img = document.createElement('img');
  img.src = imgMoreList[1];
  img.className = 'research-image centered-img';
  img.onclick = () => openModalWithIndex(1);
  imgMoreContainer.appendChild(img);

} else if (imgMoreList.length > 2) {
  // 多張 → 使用橫向滾動容器
  imgMoreContainer.classList.add('img-more-container');
  imgMoreList.slice(1).forEach((imgSrc, index) => {
    const img = document.createElement('img');
    img.src = imgSrc;
    img.onclick = () => openModalWithIndex(index + 1);
    imgMoreContainer.appendChild(img);
  });
}

// 左右箭頭
const prevBtn = document.querySelector('.prev');
const nextBtn = document.querySelector('.next');

if (prevBtn) {
  prevBtn.onclick = function () {
    if (imgMoreList.length > 1) {
      currentImgIndex = (currentImgIndex > 0)
        ? currentImgIndex - 1
        : imgMoreList.length - 1;
      modalImg.src = imgMoreList[currentImgIndex];
    }
  };
}
if (nextBtn) {
  nextBtn.onclick = function () {
    if (imgMoreList.length > 1) {
      currentImgIndex = (currentImgIndex < imgMoreList.length - 1)
        ? currentImgIndex + 1
        : 0;
      modalImg.src = imgMoreList[currentImgIndex];
    }
  };
}

updateArrowState();


      // 更新标题和内容
      document.getElementById('researchTitle').textContent = research.info;
      document.getElementById('researchName').textContent = research.title;
      document.getElementById('researchContent').textContent = research.content;

      // ========= 更新研究者資訊 =========
  (function () {
    const el = document.getElementById('researchers-info');
    const list = Array.isArray(research?.researchers) ? research.researchers : [];

    const html = list.map(r => {
      const name = (r && r.name) ? String(r.name) : '';
      const link = (r && r.link) ? String(r.link).trim() : '';
      const hasLink = !!(link && link !== '#' && link.toLowerCase() !== 'javascript:;');

      const common = `class="researcher-link" data-has-link="${hasLink}"`;
      if (hasLink) {
        // 可點：pointer、帶 data-link
        return `<span ${common} data-link="${link}" style="cursor:pointer;">${name}</span>`;
      } else {
        // 不可點：預設游標、可加 aria 提示
        return `<span ${common} aria-disabled="true" tabindex="-1" style="cursor:default;">${name}</span>`;
      }
    }).join(', ');

    el.innerHTML = `Researchers: ${html}`;

    // 僅對「有連結」的項目綁定互動
    document.querySelectorAll('.researcher-link[data-has-link="true"]').forEach(item => {
      item.addEventListener('mouseover', function () {
        this.style.color = '#f36f24';
      });
      item.addEventListener('mouseout', function () {
        this.style.color = '';
      });
      item.addEventListener('click', function () {
        const link = this.getAttribute('data-link');
        if (link) window.open(link, '_blank', 'noopener');
      });
    });

    // 可選：明確阻止「無連結」時的點擊（即使被誤綁事件也不動作）
    document.querySelectorAll('.researcher-link[data-has-link="false"]').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
      });
    });
  })();

      // 更新关键词
      const keywordsContainer = document.querySelector('.keywords-container');
      research.keywords.slice(0, 5).forEach(keyword => {
        const keywordDiv = document.createElement('div');
        keywordDiv.className = 'label_key_btn';
        keywordDiv.style.marginRight = '10px';
        keywordDiv.textContent = `#${keyword}`;
        keywordsContainer.appendChild(keywordDiv);
      });

      // 添加 "View Full Paper" 按钮
      const downloadContainer = document.querySelector('.download-container');
      if (research.pdf) {
        const viewFullPaperBtn = document.createElement('a');
        viewFullPaperBtn.className = 'label_btn';
        viewFullPaperBtn.href = research.pdf;
        viewFullPaperBtn.target = '_blank';
        viewFullPaperBtn.textContent = 'View Full Paper';
        viewFullPaperBtn.style.textDecoration = 'none';
        downloadContainer.appendChild(viewFullPaperBtn);
      }

      // 更新摘要
      if (research.abstract) {
        const formattedAbstract = research.abstract.replace(/\n/g, '<br>');
        document.getElementById('researchAbstract').innerHTML = formattedAbstract;
      }

      // contact
      const contactDetails = document.getElementById('contact-details');
      const contactSection = document.getElementById('Contact');
      const { office, school, num, email } = research;
      let contactHTML = '';
      if (Array.isArray(research.researchers) && research.researchers[0]?.name) {
        let link = research.researchers[0].link || '#';
        if (!/^https?:\/\//i.test(link)) link = `https://chive.cse.lsu.edu/${link}`;
        contactHTML += `<div><a href="${link}" target="_blank" style="cursor:pointer;text-decoration:none;">${research.researchers[0].name}</a></div>`;
      }
      if (office) contactHTML += `<div>${office}</div>`;
      if (school) contactHTML += `<div>${school}</div>`;
      if (num)    contactHTML += `<div>${num}</div>`;
      if (email)  contactHTML += `<div><a href="mailto:${email}" style="color:#3f44b6;">${email}</a></div>`;
      if (contactHTML.trim()) contactDetails.innerHTML = contactHTML; else contactSection.style.display = 'none';

      // contact hover style
      const style = document.createElement('style');
      style.innerHTML = `
        #contact-details a { color:#5f5d5d; }
        #contact-details a:hover { color:#3f44b6; }
      `;
      document.head.appendChild(style);
    })
    .catch(error => {
      console.error('Error fetching research data:', error);
    });

  // 關閉/縮放
  closeBtn.onclick = function() { modal.style.display = "none"; };
  modalImg.onclick = function() {
    zoomedIn = !zoomedIn;
    modalImg.classList.toggle('zoom-in', zoomedIn);
    modalImg.classList.toggle('zoom-out', !zoomedIn);
  };

// 2) 影片工具函式（完整）
// =======================

// 安全轉陣列
const safeArray = v => Array.isArray(v) ? v : (v == null ? [] : [v]);

// 判斷 labels 是否包含指定 tag（支援陣列或字串）
const hasTag = (labels, tag) =>
  Array.isArray(labels) ? labels.includes(tag)
  : (typeof labels === 'string' ? labels.includes(tag) : false);

// 解析 YouTube URL 參數 t=（支援數字/帶 s/或 h m s 格式）
function parseStartSeconds(urlObj) {
  const t = urlObj.searchParams.get('t') || '';
  if (!t) return 0;
  if (/^\d+$/.test(t)) return parseInt(t, 10);
  if (/^\d+s?$/i.test(t)) return parseInt(t, 10);
  const m = t.match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);
  if (!m) return 0;
  return (parseInt(m[1]||'0',10)*3600) + (parseInt(m[2]||'0',10)*60) + parseInt(m[3]||'0',10);
}

// 是否為 YouTube 網址
function isYouTubeUrl(url) {
  try {
    const u = new URL(url);
    return /(^|\.)youtube\.com$/i.test(u.hostname) || /(^|\.)youtu\.be$/i.test(u.hostname);
  } catch {
    return false;
  }
}

// 轉換為 YouTube <iframe> 可用的 embed URL（保留起始秒數）
function toYouTubeEmbed(url) {
  const u = new URL(url);
  const start = parseStartSeconds(u);
  let videoId = '';

  if (/(^|\.)youtu\.be$/i.test(u.hostname)) {
    videoId = u.pathname.replace(/^\//, '');
  } else if (/(^|\.)youtube\.com$/i.test(u.hostname)) {
    if (u.pathname === '/watch') {
      videoId = u.searchParams.get('v') || '';
    } else if (u.pathname.startsWith('/live/')) {
      videoId = u.pathname.split('/live/')[1] || '';
    } else if (u.pathname.startsWith('/shorts/')) {
      videoId = u.pathname.split('/shorts/')[1] || '';
    }
  }
  if (!videoId) return '';

  const params = new URLSearchParams({
    start: String(start || 0),
    mute: '0',          // 不靜音
    playsinline: '1',
    autoplay: '0',      // 如需自動播放改為 '1'
    rel: '0',
    iv_load_policy: '3'
  });
  if (!start) params.delete('start');

  return `https://www.youtube.com/embed/${videoId}?${params.toString()}`;
}

// 是否為瀏覽器可直接播放的影片檔
function canUseHtml5Video(url) {
  return /\.(mp4|webm|ogg)(\?.*)?$/i.test(url);
}

// 依據 URL 產生嵌入區塊（保留你的樣式）
function renderEmbed(videoUrl) {
  if (!videoUrl) return '';
  if (isYouTubeUrl(videoUrl)) {
    const embed = toYouTubeEmbed(videoUrl);
    return embed
      ? `<div class="video-container" style="margin-top:20px;position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%;background:#000;">
           <iframe
             src="${embed}"
             style="position:absolute;top:0;left:0;width:100%;height:100%;"
             frameborder="0"
             allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
             allowfullscreen
           ></iframe>
         </div>`
      : `<div style="margin-top:12px;"><a href="${videoUrl}" target="_blank" rel="noopener" style="text-decoration:none;color:#3f44b6;">Open video</a></div>`;
  } else if (canUseHtml5Video(videoUrl)) {
    return `<video controls playsinline preload="metadata" style="width:100%;max-width:100%;margin-top:12px;">
              <source src="${videoUrl}">
              Your browser does not support the video tag.
            </video>`;
  } else {
    return `<div style="margin-top:12px;"><a href="${videoUrl}" target="_blank" rel="noopener" style="text-decoration:none;color:#3f44b6;">Open video</a></div>`;
  }
}

// 取得所有 url 欄位（含 url-2、url-3…url-n），並依數字排序
function getAllUrls(infoItem) {
  if (!infoItem || typeof infoItem !== 'object') return [];
  const entries = Object.keys(infoItem)
    .filter(k => /^url(?:-\d+)?$/i.test(k)) // 匹配 url 或 url-數字
    .map(k => {
      const m = k.match(/^url(?:-(\d+))?$/i);
      const n = m && m[1] ? parseInt(m[1], 10) : 1; // 無數字者視為 1（即 url）
      return { n, v: infoItem[k] };
    })
    .filter(x => typeof x.v === 'string' && x.v.trim().length > 0);

  entries.sort((a, b) => a.n - b.n);
  return entries.map(x => x.v.trim());
}

// =======================
// 3) 渲染影片（完整）
// =======================
// 規則：
// 1) 若有任何 url* → 主影片 = 第一個 url，其餘依序追加（url-2…url-n）。
// 2) 若完全沒有 url* → 使用 videoSrc 作為主影片（不追加）。
// 3) 區塊維持你的既有樣式與結構。
function updateVideos(list) {
  const infoContent = document.getElementById('info-content');
  const videoSection = document.getElementById('Videos');
  if (!infoContent || !videoSection) return;

  // 先檢查是否有影片可顯示
  const hasVideos = safeArray(list).some(item =>
    hasTag(item?.label, 'researchDemo') &&
    (getAllUrls(item).length > 0 || item?.videoSrc)
  );
  if (!hasVideos) {
    videoSection.style.display = 'none';
    return;
  }
  videoSection.style.display = '';

  // 逐筆渲染
  safeArray(list).forEach(infoItem => {
    if (!hasTag(infoItem?.label, 'researchDemo')) return;

    const urls = getAllUrls(infoItem);   // 所有 url、url-2…url-n
    const hasAnyUrl = urls.length > 0;

    // 主/附加影片決策
    const primaryUrl = hasAnyUrl ? urls[0] : (infoItem?.videoSrc || '');
    const extraUrls  = hasAnyUrl ? urls.slice(1) : [];

    if (!primaryUrl) {
      // 既沒有 url* 也沒有 videoSrc → 不渲染
      return;
    }

    const infoDiv = document.createElement('div');
    infoDiv.classList.add('news_card');
    infoDiv.style.paddingTop = '30px';

    // Speakers（最多 1 位，沿用你的 slice(0,1)）
  const speakers = safeArray(infoItem?.researchers).slice(0, 1)
    .map(r => {
      const name = r?.name ?? '';
      const link = (r?.link || '').trim();
      const hasLink = !!(link && link !== '#' && link.toLowerCase() !== 'javascript:;');

      if (hasLink) {
        return `<a href="${link}" target="_blank" rel="noopener noreferrer"
                  class="cont-researcher-name"
                  data-has-link="true"
                  style="text-decoration:none;">${name}</a>`;
      } else {
        return `<span class="cont-researcher-name"
                     data-has-link="false"
                     aria-disabled="true" tabindex="-1"
                     style="text-decoration:none;">${name}</span>`;
      }
    })
    .filter(Boolean)
    .join(', ');

    // 內嵌影片 HTML
    const embedHTMLPrimary = renderEmbed(primaryUrl);
    const embedHTMLExtras  = extraUrls.map(u => renderEmbed(u)).join('');

    // 標題連結：有 url* 時連到第一個 url；否則連到 videoSrc（若是直連檔亦可）
    const titleHref = hasAnyUrl ? primaryUrl : (infoItem?.videoSrc || '#');

    // 組裝卡片
    infoDiv.innerHTML = `
      <div class="sec_sub_title">${infoItem?.info ?? ''}${infoItem?.place ? (' | ' + infoItem.place) : ''}</div>
      <div class="sub-title_s">
        <a href="${titleHref}" style="text-decoration:none;color:#3f44b6;" rel="alternate bookmark" target="_blank">${infoItem?.title ?? ''}</a>
      </div>
      <div class="cont overflow">${infoItem?.date ?? ''}</div>
      ${speakers ? `<div class="cont overflow cursor">Speakers: ${speakers}</div>` : ''}
      ${embedHTMLPrimary}
      ${embedHTMLExtras}
    `;

    infoContent.appendChild(infoDiv);
  });

  // （選擇性）確保所有 HTML5 <video> 都不靜音
  //infoContent.querySelectorAll('video').forEach(v => { try { v.muted = false; } catch {} });
}

// 影片資料載入（保持你原本路徑）
fetch('/json/research/research.json', { cache: 'no-store' })
  .then(r => r.json())
  .then(videoList => { updateVideos(videoList); })
  .catch(err => console.error('Error fetching videos data:', err));

  // 4) Publications
  fetch('/json/research/publications.json')
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
      return response.json();
    })
    .then(data => {
      const accordionContainer = document.getElementById('accordion-2');
      let firstAccordionOpened = false;

      const hasPublications = data.years?.some(y =>
        y.publications?.some(pub => Array.isArray(pub.label) && pub.label.includes('researchDemo'))
      );

      if (!hasPublications) {
        const pubsSec = document.getElementById('Publications');
        if (pubsSec) pubsSec.style.display = 'none';
        return;
      }

      // 小工具：渲染作者（有 link 用 <a>，無 link 用 <span>）
      const renderAuthor = (a) => {
        const name = (a && a.name) ? String(a.name) : '';
        const link = (a && a.link) ? String(a.link).trim() : '';
        const hasLink = !!(link && link !== '#' && link.toLowerCase() !== 'javascript:;');

        if (hasLink) {
          return `<a href="${link}" target="_blank" rel="noopener noreferrer"
                     class="cont-researcher-name author-link"
                     data-has-link="true"
                     style="text-decoration:none;">${name}</a>`;
        } else {
          return `<span class="cont-researcher-name author-link"
                       data-has-link="false"
                       aria-disabled="true" tabindex="-1"
                       style="text-decoration:none;">${name}</span>`;
        }
      };

      data.years.forEach((year) => {
        const filtered = (year.publications || []).filter(pub =>
          Array.isArray(pub.label) && pub.label.includes('researchDemo')
        );
        if (!filtered.length) return;

        const item = document.createElement('div');
        item.classList.add('accordion-item');

        const heading = document.createElement('div');
        heading.classList.add('accordion-heading');
        heading.innerHTML = `<h3>${year.year}</h3><div class="icon"><i class="arrow right"></i></div>`;
        item.appendChild(heading);

        const content = document.createElement('div');
        content.classList.add('accordion-content');
        if (!firstAccordionOpened) {
          content.style.display = 'block';
          firstAccordionOpened = true;
        }

        filtered
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .forEach(pub => {
            const div = document.createElement('div');
            div.style.paddingBottom = '30px';

            let awardIcon = '';
            if ((pub.venues || '').includes('Best Paper Award')) {
              awardIcon = `<img src="../img/icons/trophy.png" alt="Trophy" style="height:1em;vertical-align:middle;margin-right:5px;">`;
            } else if ((pub.venues || '').includes('Best Paper Honorable Mention Award')) {
              awardIcon = `<img src="../img/icons/medal.png" alt="Medal" style="height:1em;vertical-align:middle;margin-right:5px;">`;
            }

            const venuesContent = pub.venues
              ? `${awardIcon}<a href="${pub.url}" style="text-decoration:none;color:#ab2d05;" target="_blank" rel="noopener noreferrer"><strong>${pub.venues}</strong></a> <a style="color:#3f44b6;"> | `
              : '';

            const pdfContent = pub.pdf
              ? `<div class="sec_sub_title_a" style="margin-top:5px;margin-bottom:5px;"><a href="${pub.pdf}" style="color:#3f44b6;" target="_blank" rel="noopener noreferrer">View Publication</a></div>`
              : '';

            const authorsHTML = (pub.authors || []).map(renderAuthor).join(', ');

            div.innerHTML = `
              <div class="sub-title_ss">
                ${venuesContent}<a href="${pub.url}" style="text-decoration:none;color:#3f44b6;" target="_blank" rel="noopener noreferrer">${pub.title}</a>
              </div>
              <div class="cont-researche overflow">${authorsHTML}</div>
              <div class="sec_sub_title_s" style="margin-top:5px;margin-bottom:5px;">${pub.venuesname || ''} | ${pub.date || ''}</div>
              <div class="sec_sub_title_s" style="margin-top:5px;margin-bottom:5px;">${pub.description || ''}</div>
              ${pdfContent}
            `;
            content.appendChild(div);
          });

        item.appendChild(content);
        accordionContainer.appendChild(item);
      });

      // Accordion（注意 mn-accordion.js 是否正確載入）
      var accordion_2 = new Accordion(accordionContainer, { multiple: true, defaultOpenedIndexes: [0] });
    })
    .catch(error => {
      console.error('Error fetching publications data:', error);
    });
});
</script>


</body>
</html>
