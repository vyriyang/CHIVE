<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHIVE • Activity</title>
  <link rel="stylesheet" href="dist/css/scrollspy.css"/>
  <link rel="stylesheet" href="dist/css/nav.css"/>
  <style>
    /* 限制 content 顯示的行數 */
    .cont_bottom {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cont-activity {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 10px;
    }

    .sub-title {
      cursor: pointer;
      color: #3f44b6;
      text-decoration: none;
      margin-bottom: 10px;
    }

    .list_img {
      width: 100%;
      height: auto;
      object-fit: cover;
      object-position: top;
      max-height: 300px;
      cursor: pointer;
    }

    .cont-activity-name {
      text-decoration: none;
      color: #5f5d5d;
    }

    /* ===================== 圖片預覽遮罩（保留你原本的結構） ===================== */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      /* ★ 提高層級，確保永遠在其他元素之上（避免 Footer 影響預覽/文字位置） */
      z-index: 12000;
      background-color: rgba(37,37,37,0.6);
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .modal-content {
      margin: auto;
      position: relative;
      max-height: 80vh;
      width: auto;
      height: auto;
      text-align: center;
    }

    .modal img {
      height: 80vh;
      width: auto;
      max-width: 80%;
      object-fit: contain;
      /* 新增：避免換圖時撐到空白閃爍，交給 JS 控制 visibility */
    }

    /* 關閉按鈕（圖片預覽） */
    .close {
      position: absolute;
      top: 10px;
      right: 20px;
      color: white;      /* 保持白色 */
      font-size: 40px;
      cursor: pointer;
    }
    .close:hover { color: #bbb; }

    /* 左右箭頭（圖片預覽） */
    .arrow {
      cursor: pointer;
      position: absolute;
      top: 50%;
      padding: 16px;
      margin-top: -22px;
      color: white;
      font-size: 18px;
      user-select: none;
      transition: 0.2s ease;
    }
    .prev { left: 0; }
    .next { right: 0; }
    .arrow:hover { background-color: rgba(0,0,0,0.5); }

    /* 黑色方框容器：全寬，內容上下居中 */
    .modal-info {
      position: relative;
      background-color: rgba(0,0,0,0.7);
      padding: 20px;
      width: 100%;
      margin-top: 20px;

      /* Flex 垂直水平置中 */
      display: flex;
      justify-content: center;   /* 水平置中整個內容區 */
      align-items: center;       /* ★ 垂直居中 */
      min-height: 120px;         /* 黑色方框高度，可調整 */
      box-sizing: border-box;
    }

    /* 內部文字區：限制寬度，保持左對齊 */
    .modal-info-content {
      width: 80%;
      max-width: 1080px;
      text-align: left;          /* ★ 左對齊文字 */
    }

    .modal-info-content h2 {
      font-size: 24px;
      color: #fff;
      margin: 5px 0;
    }
    .modal-info-content p {
      font-size: 16px;
      margin: 5px 0;
      color: #fff;
    }

    /* ========== 新增：載入中指示器（僅在換圖/首次開啟時顯示） ========== */
    .modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;     /* 由 JS 控制顯示/隱藏 */
      width: 56px;
      height: 56px;
      border: 4px solid rgba(255,255,255,0.25);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: modal-spin 0.9s linear infinite;
      z-index: 1;        /* 在圖片上面 */
    }
    @keyframes modal-spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* ===== researchProject 專用 Footer Modal ===== */
.modal-footer-rp {
  position: fixed;
  inset: 0;
  display: none;
  background: rgba(0,0,0,0.5);
  z-index: 9000;
}

/* 彈窗居中偏上 */
.modal-content-footer-rp {
  position: absolute;
  left: 50%;
  top: 42%;
  transform: translate(-50%, -50%);
  width: min(720px, 92vw);
  max-height: 80vh;
  overflow: auto;
  background: #fff;
  border-radius: 10px;
  padding: 22px 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

/* 關閉按鈕 */
.modal-footer-rp .footer-close-rp {
  position: absolute;
  right: 12px;
  top: 10px;
  font-size: 24px;
  color: #000;
  cursor: pointer;
  transition: color .2s ease;
}
.modal-footer-rp .footer-close-rp:hover { color: #555; }

/* Footer links hover 色 */
#footer .footer a {
  color: #fff;
  text-decoration: none;
  transition: color 0.2s ease-in-out;
}
#footer .footer a:hover {
  color: #f36f24;
}
  </style>
</head>
<body>
  <header>
    <div class="logo-container" onclick="window.location.href='index.html';" style="cursor: pointer;">
      <img src="img/logo/CHIVE-2.svg" alt="Logo">
      <div class="logo-text">Research Lab at LSU</div>
    </div>
    <nav class="scrollspy-nav">
      <a class="scrollspy-link" href="index.html">Home</a>
      <a class="scrollspy-link" href="research.html">Research</a>
      <a class="scrollspy-link" href="publications.html">Publications</a>
      <a class="scrollspy-link" href="people.html">People</a>
      <a class="scrollspy-link" href="news.html">News</a>
      <a class="scrollspy-link" href="activity.html">Activity</a>
      <a class="scrollspy-link" href="resource.html">Resource</a>
    </nav>
  </header>

  <section class="scrollspy-section" id="Research">
    <div class="section_2">
      <div class="title">Activity
        <div class="line"></div>
      </div>
      <div class="grids-news" id="activityGrids"></div>
    </div>
  </section>

  <section class="scrollspy-section">
    <div class="gray">
      <div class="section_2">
        <div class="title">Contact Us
          <div class="line"></div>
        </div>
        <div class="sec_sub_title" style="margin-top: 60px;">2329 Patrick F Taylor Building, Baton Rouge, LA 70803</div>
        <div class="sec_sub_title" style="margin-bottom: 60px;">Louisiana State University</div>
      </div>
    </div>
  </section>

  <div id="footer"></div>
  <!-- ★ Footer 的彈窗容器（與圖片預覽分離，避免互相影響） -->
  <div id="modals-footer-rp"></div>

  <!-- 圖片預覽懸浮窗口（保留原本） -->
  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <span class="close" aria-label="Close">&times;</span>

    <!-- 新增：載入中指示器（置於圖片之上） -->
    <div id="modalLoading" class="modal-loading" aria-hidden="true"></div>

    <img class="modal-content" id="modalImage" alt="">

    <span class="arrow prev" aria-label="Previous">&#10094;</span>
    <span class="arrow next" aria-label="Next">&#10095;</span>
    <div class="modal-info" id="modalInfo">
      <div class="modal-info-content">
        <h2 id="modalTitle"></h2>
        <p id="modalDate"></p>
        <p id="modalContent"></p>
      </div>
    </div>
  </div>

  <script src="dist/js/mn-accordion.js"></script>
  <script src="dist/js/scrollspy.min.js"></script>
  <script>
/* ===== researchProject 專屬 Footer（與主頁功能等同） ===== */
(function () {
  // 1) 讀取 footer.json（用絕對路徑，避免子資料夾路徑錯誤）
  fetch('/json/footer.json', { cache: 'no-store' })
    .then(res => {
      if (!res.ok) throw new Error('Failed to load /json/footer.json');
      return res.json();
    })
    .then(data => {
      // 2) 渲染 footer 連結（與主頁一致，但 modal 走本頁專用 API）
      const footer = document.getElementById('footer') || (function () {
        // 若頁面沒有 #footer，動態創建一個，避免你改 HTML
        const f = document.createElement('div');
        f.id = 'footer';
        document.body.appendChild(f);
        return f;
      })();

      const linksHtml = (data?.footer?.links || []).map(link => {
        if (link.type === 'modal') {
          // 對應本頁專用的 open 函式
          return `<a href="javascript:void(0)" onclick="openModal_footerRP('rp-${link.target}')">${link.title}</a>`;
        } else {
          const href = link?.href || '#';
          return `<a href="${href}">${link.title}</a>`;
        }
      }).join(' | ');

      footer.innerHTML = `
        <div class="footer">
          <p class="footer-links">${linksHtml}</p>
          <p class="footer-copy">${data?.footer?.copyright || ''}</p>
        </div>
      `;

      // 3) 渲染「本頁專用」footer modals 到獨立容器（避免動到你的 #modals）
      let modalsContainer = document.getElementById('modals-footer-rp');
      if (!modalsContainer) {
        modalsContainer = document.createElement('div');
        modalsContainer.id = 'modals-footer-rp';
        document.body.appendChild(modalsContainer);
      }

      modalsContainer.innerHTML = (data?.modals || []).map(m => `
        <div id="rp-${m.id}" class="modal-footer-rp" role="dialog" aria-modal="true" aria-labelledby="rp-${m.id}-title" style="display:none;">
          <div class="modal-content-footer-rp">
            <span class="footer-close-rp" onclick="closeModal_footerRP('rp-${m.id}')" aria-label="Close">&times;</span>
            <h2 id="rp-${m.id}-title">${m.title || ''}</h2>
            <p>${m.content || ''}</p>
          </div>
        </div>
      `).join('');
    })
    .catch(err => console.error(err));
})();

/* ===== 僅供 researchProject footer 使用的控制函式（不會覆蓋全域） ===== */
function openModal_footerRP(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
}
function closeModal_footerRP(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}
// 只關閉「本頁 footer」的彈窗，不影響你的其它 modal
window.addEventListener('click', (e) => {
  if (e.target.classList && e.target.classList.contains('modal-footer-rp')) {
    e.target.style.display = 'none';
  }
});

    /* ===================== Activity 資料與圖片預覽 ===================== */
    document.addEventListener('DOMContentLoaded', function () {
      const modal        = document.getElementById('modal');
      const modalImage   = document.getElementById('modalImage');
      const modalLoading = document.getElementById('modalLoading');
      const closeBtn     = document.querySelector('.close');
      const prevArrow    = document.querySelector('.prev');
      const nextArrow    = document.querySelector('.next');
      const modalTitle   = document.getElementById('modalTitle');
      const modalDate    = document.getElementById('modalDate');
      const modalContent = document.getElementById('modalContent');

      const safeArray = (v) => Array.isArray(v) ? v : (v ? [v] : []);

      let currentImageIndex = 0; // 全局索引（允許跨活動）
      let images = [];           // 全部圖片 URL（跨活動）
      let imageDetails = [];     // 與 images 對應的詳情（含本活動內序號/總數）

      /* === 新增：集中控制 loading 顯示/隱藏，並避免上一張殘留 === */
      function showLoading(show) {
        if (show) {
          modalLoading.style.display = 'block';
          modalLoading.setAttribute('aria-hidden', 'false');
          modal.setAttribute('aria-busy', 'true');
        } else {
          modalLoading.style.display = 'none';
          modalLoading.setAttribute('aria-hidden', 'true');
          modal.removeAttribute('aria-busy');
        }
      }

      const closeModal = () => { modal.style.display = 'none'; };
      closeBtn.onclick = closeModal;

      // 點擊遮罩背景關閉（避免點擊圖片本體關閉）
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      // 最多三行的內容截斷（以單詞粗略估行）
      function truncateContent(content = '') {
        const maxLines = 3, words = String(content).split(/\s+/);
        let buf = '', lines = 0, sentenceEnd = '';
        for (let i = 0; i < words.length; i++) {
          buf += words[i] + ' ';
          if ((i + 1) % 10 === 0) lines++;
          if (lines >= maxLines && /[.!?。！？]$/.test(words[i])) {
            sentenceEnd = buf.slice(0, buf.trimEnd().lastIndexOf(words[i]) + words[i].length);
            break;
          }
        }
        if (lines >= maxLines && !sentenceEnd) return buf.trim();
        return sentenceEnd || buf.trim();
      }

      /* === 改造：先隱藏舊圖 -> 顯示 loading -> 等新圖載入完成後再顯示 === */
      function renderModalByIndex(idx) {
        const d = imageDetails[idx];
        if (!d) return;

        // 先更新文字與箭頭狀態（不影響樣式）
        modalTitle.textContent   = `${d.title} (${d.localIndex + 1}/${d.localTotal})`;
        modalDate.textContent    = d.date || '';
        modalContent.textContent = truncateContent(d.content || 'No content available.');

        if (images.length > 1) { 
          prevArrow.style.display = 'block'; 
          nextArrow.style.display = 'block'; 
        } else { 
          prevArrow.style.display = 'none'; 
          nextArrow.style.display = 'none'; 
        }

        // 隱藏舊圖，顯示 loading
        modalImage.style.visibility = 'hidden';
        showLoading(true);

        // 預載新圖
        const nextSrc = images[idx];
        const tmp = new Image();

        tmp.onload = function () {
          // 確保成功後再替換 src，並顯示新圖
          modalImage.src = nextSrc;
          modalImage.style.visibility = 'visible';
          showLoading(false);
        };

        tmp.onerror = function () {
          showLoading(false);
          modalImage.style.visibility = 'hidden';
          modalContent.textContent = 'Image failed to load.';
        };

        // 觸發載入
        tmp.src = nextSrc;
      }

      function openModal(startIndex) {
        currentImageIndex = startIndex;
        modal.style.display = 'flex';
        renderModalByIndex(currentImageIndex);
      }

      prevArrow.onclick = function () {
        currentImageIndex = (currentImageIndex > 0) ? currentImageIndex - 1 : images.length - 1;
        renderModalByIndex(currentImageIndex);
      };
      nextArrow.onclick = function () {
        currentImageIndex = (currentImageIndex < images.length - 1) ? currentImageIndex + 1 : 0;
        renderModalByIndex(currentImageIndex);
      };

      // 鍵盤：← → 切換，Esc 關閉
      document.addEventListener('keydown', (e) => {
        if (modal.style.display !== 'flex') return;
        if (e.key === 'ArrowLeft')  { e.preventDefault(); prevArrow.click(); }
        if (e.key === 'ArrowRight') { e.preventDefault(); nextArrow.click(); }
        if (e.key === 'Escape')     { e.preventDefault(); closeModal(); }
      });

      // 讀取 JSON 並填充
      fetch('/json/activity.json', { cache: 'no-store' })
        .then(res => res.json())
        .then(data => {
          const activityGrids = document.getElementById('activityGrids');

          // 按時間降序
          data.sort((a, b) => new Date(b.date) - new Date(a.date));

          const allImages = [];
          const allDetails = [];

          data.forEach(item => {
            // 跳過 last
            if (Array.isArray(item.label) && item.label.includes('last')) return;

            // 建立卡片
            const activityList = document.createElement('div');
            activityList.className = 'activity_list';
            activityList.innerHTML = `
              <img src="${item.imgSrc}" alt="" class="list_img">
              <div class="research_padding">
                <div class="sub-title-news">${item.title}</div>
                <div class="cont-activity-name">${item.date || ''}</div>
              </div>
            `;

            // 該活動的所有圖片（主圖 + 其他）
            const activityImages = [item.imgSrc, ...safeArray(item.imgMore).filter(Boolean)];

            // 推入全域列表
            activityImages.forEach((src, localIndex) => {
              allImages.push(src);
              allDetails.push({
                title: item.title,
                date: item.date,
                content: item.content || '',
                localIndex,
                localTotal: activityImages.length
              });
            });

            // 點擊卡片：從該活動主圖的全域位置打開彈窗
            activityList.addEventListener('click', function () {
              const firstGlobalIndex = allImages.indexOf(item.imgSrc);
              openModal(firstGlobalIndex >= 0 ? firstGlobalIndex : 0);
            });

            activityGrids.appendChild(activityList);
          });

          // 彙總到外層變數（保留跨活動輪播）
          images = allImages;
          imageDetails = allDetails;
        })
        .catch(err => {
          console.error('Failed to load /json/activity.json:', err);
        });
    });
  </script>
</body>
</html>






